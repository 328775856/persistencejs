var persistence=window.persistence||{};
(function(){function k(a){function d(e){var c=this;this._id=F();this._new=true;this._type=a;this._dirtyProperties={};this._data={};this._data_obj={};for(var g in b.fields)(function(){if(b.fields.hasOwnProperty(g)){var f=g;c.__defineSetter__(f,function(j){c._data[f]=j;c._dirtyProperties[f]=true});c.__defineGetter__(f,function(){return c._data[f]})}})();for(var i in b.hasOne)b.hasOne.hasOwnProperty(i)&&function(){var f=i;c.__defineSetter__(f,function(j){if(j==null){c._data[f]=null;c._data_obj[f]=undefined}else if(j._id){c._data[f]=
j._id;c._data_obj[f]=j;persistence.add(j)}else c._data[f]=j;c._dirtyProperties[f]=true});c.__defineGetter__(f,function(){if(c._data[f]===null||c._data_obj[f]!==undefined)return c._data_obj[f];else throw"Property '"+f+"' with id: "+c._data[f]+" not fetched, either prefetch it or fetch it manually.";})}();for(i in b.hasMany)b.hasMany.hasOwnProperty(i)&&function(){var f=i;if(b.hasMany[f].manyToMany){c.__defineSetter__(f,function(){throw"Not yet supported.";});c.__defineGetter__(f,function(){if(this._data[f])return c._data[f];
else{var j=b.hasMany[f].type.meta,l=new t(b.hasMany[f].type.meta.name);l._additionalJoinSqls.push("LEFT JOIN `"+b.hasMany[f].tableName+"` AS mtm ON mtm.`"+j.name+"_"+b.hasMany[f].inverseProperty+"` = `"+j.name+"`.`id` ");l._additionalWhereSqls.push("mtm.`"+b.name+"_"+f+"` = '"+c._id+"'");return c._data[f]=l}})}else{c.__defineSetter__(f,function(){throw"Not yet supported.";});c.__defineGetter__(f,function(){if(this._data[f])return c._data[f];else{var j=(new u(b.hasMany[f].type.meta.name)).filter(b.hasMany[f].inverseProperty,
"=",c);return c._data[f]=j}})}}();for(var h in e)if(e.hasOwnProperty(h))c[h]=e[h]}if(D[a])return persistence._entityClassCache[a];var b=n[a];d.meta=b;d.all=function(){return new u(a)};d.hasMany=function(e,c,g){var i=c.meta;if(i.hasMany[g]){var h=b.name+"_"+e+"_"+i.name,f=i.name+"_"+g+"_"+b.name;if(h>f)h=f;b.hasMany[e]={type:c,inverseProperty:g,manyToMany:true,tableName:h};i.hasMany[g]={type:d,inverseProperty:e,manyToMany:true,tableName:h};delete b.hasOne[e]}else{b.hasMany[e]={type:c,inverseProperty:g};
i.hasOne[g]={type:d,inverseProperty:e}}};d.hasOne=function(e,c){b.hasOne[e]={type:c}};return D[a]=d}function v(a,d,b){var e=[],c=[],g=[],i=[];for(var h in a._dirtyProperties)if(a._dirtyProperties.hasOwnProperty(h)){e.push("`"+h+"`");c.push(persistence.entityValToDbVal(a[h]));g.push("?");i.push("`"+h+"` = ?")}if(e.length===0)b();else{a._dirtyProperties={};if(a._new){e.push("id");c.push(a._id);g.push("?");e="INSERT INTO `"+a._type+"` ("+e.join(", ")+") VALUES ("+g.join(", ")+")";a._new=false}else e=
"UPDATE `"+a._type+"` SET "+i.join(",")+" WHERE id = '"+a._id+"'";d.executeSql(e,c,b)}}function G(a,d,b){function e(){var i=d.pop();a.executeSql(i[0],i[1],function(){if(d.length>0)e();else b&&b.apply(this,c)})}for(var c=[],g=3;g<arguments.length;g++)c.push(arguments[g]);if(d.length>0)e();else b&&b.apply(this,c)}function F(){for(var a=[],d=0;d<32;d++)a[d]="0123456789ABCDEF".substr(Math.floor(Math.random()*16),1);a[12]="4";a[16]="0123456789ABCDEF".substr(a[16]&3|8,1);return a.join("")}function H(){this.sql=
function(){return"1=1"};this.match=function(){return true};this.makeFit=function(){};this.makeNotFit=function(){}}function I(a,d){this.sql=function(b,e){return"("+a.sql(b,e)+" AND "+d.sql(b,e)+")"};this.match=function(b){return a.match(b)&&d.match(b)};this.makeFit=function(b){a.makeFit(b);d.makeFit(b)};this.makeNotFit=function(b){a.makeNotFit(b);d.makeNotFit(b)}}function J(a,d,b){this.sql=function(e,c){if(d==="="&&b===null)return"`"+e+a+"` IS NULL";else if(d==="!="&&b===null)return"`"+e+a+"` IS NOT NULL";
else{c.push(persistence.entityValToDbVal(b));return"`"+e+a+"` "+d+" ?"}};this.match=function(e){switch(d){case "=":return e[a]===b;case "!=":return e[a]!==b;case "<":return e[a]<b;case "<=":return e[a]<=b;case ">":return e[a]>b;case ">=":return e[a]>=b}};this.makeFit=function(e){if(d==="=")e[a]=b;else throw"Sorry, can't perform makeFit for other filters than =";};this.makeNotFit=function(e){if(d==="=")e[a]=null;else throw"Sorry, can't perform makeNotFit for other filters than =";}}function q(){}function u(a){this.init(a,
u)}function t(a){this.init(a,t)}var n={},r={};persistence.trackedObjects=r;persistence.getMeta=function(a){return n[a]};persistence.connect=function(a,d,b){persistence._conn=persistence.db.connect(a,d,b)};persistence.transaction=function(a){persistence._conn.transaction(a)};persistence.define=function(a,d){if(n[a])return k(a);n[a]={name:a,fields:d,hasMany:{},hasOne:{}};return k(a)};persistence.schemaSync=function(a){var d=[],b={};for(var e in n)if(n.hasOwnProperty(e)){var c=n[e],g="";for(var i in c.fields)if(c.fields.hasOwnProperty(i))g+=
i+" "+c.fields[i]+", ";for(var h in c.hasOne)if(c.hasOne.hasOwnProperty(h)){var f=c.hasOne[h].type.meta;g+=h+" VARCHAR(255), ";d.push(["CREATE INDEX IF NOT EXISTS `"+c.name+"_"+h+"_"+f.name+"` ON `"+c.name+"` (`"+h+"`)",null])}for(h in c.hasMany)if(c.hasMany.hasOwnProperty(h)&&c.hasMany[h].manyToMany){var j=c.hasMany[h].tableName;if(!b[j]){f=c.hasMany[h].type.meta;d.push(["CREATE TABLE IF NOT EXISTS `"+j+"` (`"+c.name+"_"+h+"` VARCHAR(32), `"+f.name+"_"+c.hasMany[h].inverseProperty+"` VARCHAR(32))",
null]);d.push(["CREATE INDEX IF NOT EXISTS `"+j+"_"+c.name+"_"+h+"` ON `"+j+"` (`"+c.name+"_"+h+"`)",null]);d.push(["CREATE INDEX IF NOT EXISTS `"+j+"_"+f.name+"_"+c.hasMany[h].inverseProperty+"` ON `"+j+"` (`"+f.name+"_"+c.hasMany[h].inverseProperty+"`)",null]);b[j]=true}}g=g.substring(0,g.length-2);b[c.name]=true;d.push(["CREATE TABLE IF NOT EXISTS `"+c.name+"` ( id VARCHAR(32) PRIMARY KEY, "+g+")",null])}persistence.transaction(function(l){G(l,d,a,l)})};persistence.add=function(a){r[a._id]||(r[a._id]=
a)};persistence.flush=function(a,d){function b(){var g=e.pop();v(g,a,function(){if(e.length>0)b();else d&&d()})}var e=[];for(var c in r)r.hasOwnProperty(c)&&e.push(r[c]);e.length>0?b():d()};persistence.clean=function(){persistence.trackedObjects={}};persistence.reset=function(a){function d(){var e=b.pop();a.executeSql("DROP TABLE "+e,null,function(){b.length>0&&d()})}var b=[];for(p in n)n.hasOwnProperty(p)&&b.push(p);d()};persistence.rowToEntity=function(a,d,b){b=b||"";if(r[d[b+"id"]])return r[d[b+
"id"]];var e=n[a];a=new (k(a));a._id=d[b+"id"];a._new=false;for(var c in d)if(d.hasOwnProperty(c))if(c.substring(0,b.length)===b){var g=c.substring(b.length);if(g!="id")a[g]=persistence.dbValToEntityVal(d[c],e.fields[g])}return a};persistence.dbValToEntityVal=function(a,d){switch(d){case "BOOL":return a===1;default:return a}};persistence.entityValToDbVal=function(a,d){return a===undefined?null:a._id?a._id:d==="BOOL"?a?1:0:a};var D={};q.prototype.init=function(a,d){this._filter=new H;this._orderColumns=
[];this._prefetchFields=[];this._additionalJoinSqls=[];this._additionalWhereSqls=[];this._entityName=a;this._constructor=d};q.prototype.clone=function(){var a=new this._constructor(this._entityName);a._filter=this._filter;a._prefetchFields=this._prefetchFields.slice(0);a._orderColumns=this._orderColumns.slice(0);return a};q.prototype.filter=function(a,d,b){var e=this.clone();e._filter=new I(this._filter,new J(a,d,b));return e};q.prototype.order=function(a,d){d=d||true;var b=this.clone();b._orderColumns.push([a,
d]);return b};q.prototype.prefetch=function(a){var d=this.clone();d._prefetchFields.push(a);return d};q.prototype.add=function(a){if(!a._id||!a._type)throw"Cannot add object of non-entity type onto collection.";persistence.add(a);this._filter.makeFit(a)};q.prototype.remove=function(a){if(!a._id||!a._type)throw"Cannot remove object of non-entity type from collection.";persistence.add(a);this._filter.makeNotFit(a)};u.prototype=new q;u.prototype.list=function(a,d){function b(o,w,s){var x=["`"+w+"`.id AS "+
s+"id"];for(var m in o.fields)o.fields.hasOwnProperty(m)&&x.push("`"+w+"`.`"+m+"` AS `"+s+m+"`");for(m in o.hasOne)o.hasOne.hasOwnProperty(m)&&x.push("`"+w+"`.`"+m+"` AS `"+s+m+"`");return x}for(var e=this._entityName,c=persistence.getMeta(e),g=this,i=[],h=e+"_",f=b(c,c.name,h),j=this._additionalJoinSqls.join(" "),l=0;l<this._prefetchFields.length;l++){var y=this._prefetchFields[l],z=c.hasOne[y].type.meta,A=z.name+"_"+y+"_tbl";f=f.concat(b(z,A,y+"_"));j+="LEFT JOIN `"+z.name+"` AS `"+A+"` ON `"+A+
"`.`id` = `"+h+y+"` "}l="WHERE "+[this._filter.sql(h,i)].concat(this._additionalWhereSqls).join(" AND ");var E="SELECT "+f.join(", ")+" FROM `"+e+"` "+j+" "+l;if(this._orderColumns.length>0)E+=" ORDER BY "+this._orderColumns.map(function(o){return"`"+h+o[0]+"` "+(o[1]?"ASC":"DESC")}).join(", ");persistence.flush(a,function(){a.executeSql(E,i,function(o){for(var w=[],s=0;s<o.length;s++){for(var x=o[s],m=persistence.rowToEntity(e,x,h),B=0;B<g._prefetchFields.length;B++){var C=g._prefetchFields[B];m[C]=
persistence.rowToEntity(c.hasOne[C].type.meta.name,x,C+"_")}w.push(m);persistence.add(m)}d(w)})})};t.prototype=new u;t.prototype.add=function(){throw"Not yet implemented";};t.prototype.remove=function(){throw"Not yet implemented";};t.prototype.persist=function(){console.log("Called persist!")};persistence.db=persistence.db||{};persistence.db.implementation="unsupported";persistence.db.conn=null;persistence.db.log=true;if(window.google&&google.gears)persistence.db.implementation="gears";else if(window.openDatabase)persistence.db.implementation=
"html5";persistence.db.html5={};persistence.db.html5.connect=function(a,d,b){var e={},c=openDatabase(a,"1.0",d,b);e.transaction=function(g){return c.transaction(function(i){return g(persistence.db.html5.transaction(i))})};return e};persistence.db.html5.transaction=function(a){var d={};d.executeSql=function(b,e,c,g){persistence.db.log&&console.log(b);a.executeSql(b,e,function(i,h){if(c){i=[];for(var f=0;f<h.rows.length;f++)i.push(h.rows.item(f));c(i)}},g)};return d};persistence.db.gears={};persistence.db.gears.connect=
function(a){var d={},b=google.gears.factory.create("beta.database");b.open(a);d.transaction=function(e){e(persistence.db.gears.transaction(b))};return d};persistence.db.gears.transaction=function(a){var d={};d.executeSql=function(b,e,c){persistence.db.log&&console.log(b);b=a.execute(b,e);if(c){for(e=[];b.isValidRow();){for(var g={},i=0;i<b.fieldCount();i++)g[b.fieldName(i)]=b.field(i);e.push(g);b.next()}c(e)}};return d};persistence.db.connect=function(a,d,b){if(persistence.db.implementation=="html5")return persistence.db.html5.connect(a,
d,b);else if(persistence.db.implementation=="gears")return persistence.db.gears.connect(a)}})();Number.prototype.equals=function(k){return this==k};Boolean.prototype.equals=function(k){return this==k};String.prototype.equals=function(k){return this==k};Array.prototype.equals=function(k){if(this.length!==k.length)return false;for(var v=0;v<this.length;v++)if(!this[v].equals(k[v]))return false;return true};
