var persistence=window.persistence||{};
(function(){function k(a){function c(d){var e=this;this.id=H();this._new=true;this._type=a;this._dirtyProperties={};this._data={};this._data_obj={};for(var h in b.fields)(function(){if(b.fields.hasOwnProperty(h)){var f=h;e.__defineSetter__(f,function(j){e._data[f]=j;e._dirtyProperties[f]=true});e.__defineGetter__(f,function(){return e._data[f]})}})();for(var g in b.hasOne)b.hasOne.hasOwnProperty(g)&&function(){var f=g;e.__defineSetter__(f,function(j){if(j==null){e._data[f]=null;e._data_obj[f]=undefined}else if(j.id){e._data[f]=
j.id;e._data_obj[f]=j;persistence.add(j)}else e._data[f]=j;e._dirtyProperties[f]=true});e.__defineGetter__(f,function(){if(e._data[f]===null||e._data_obj[f]!==undefined)return e._data_obj[f];else throw"Property '"+f+"' with id: "+e._data[f]+" not fetched, either prefetch it or fetch it manually.";})}();for(g in b.hasMany)b.hasMany.hasOwnProperty(g)&&function(){var f=g;if(b.hasMany[f].manyToMany){e.__defineSetter__(f,function(){throw"Not yet supported.";});e.__defineGetter__(f,function(){if(this._data[f])return e._data[f];
else{var j=b.hasMany[f].type.meta,l=new u(j.name);l.initManyToMany(e,f);l._additionalJoinSqls.push("LEFT JOIN `"+b.hasMany[f].tableName+"` AS mtm ON mtm.`"+j.name+"_"+b.hasMany[f].inverseProperty+"` = `"+j.name+"`.`id` ");l._additionalWhereSqls.push("mtm.`"+b.name+"_"+f+"` = '"+e.id+"'");return e._data[f]=l}})}else{e.__defineSetter__(f,function(){throw"Not yet supported.";});e.__defineGetter__(f,function(){if(this._data[f])return e._data[f];else{var j=(new v(b.hasMany[f].type.meta.name)).filter(b.hasMany[f].inverseProperty,
"=",e);return e._data[f]=j}})}}();for(var i in d)if(d.hasOwnProperty(i))e[i]=d[i]}if(B[a])return B[a];var b=r[a];c.meta=b;c.prototype.equals=function(d){return this.id==d.id};c.all=function(){return new v(a)};c.hasMany=function(d,e,h){var g=e.meta;if(g.hasMany[h]){var i=b.name+"_"+d+"_"+g.name,f=g.name+"_"+h+"_"+b.name;if(i>f)i=f;b.hasMany[d]={type:e,inverseProperty:h,manyToMany:true,tableName:i};g.hasMany[h]={type:c,inverseProperty:d,manyToMany:true,tableName:i};delete b.hasOne[d]}else{b.hasMany[d]=
{type:e,inverseProperty:h};g.hasOne[h]={type:c,inverseProperty:d}}};c.hasOne=function(d,e){b.hasOne[d]={type:e}};return B[a]=c}function o(a,c,b){var d=r[a._type],e=[],h=[],g=[],i=[];for(var f in a._dirtyProperties)if(a._dirtyProperties.hasOwnProperty(f)){e.push("`"+f+"`");h.push(persistence.entityValToDbVal(a[f]));g.push("?");i.push("`"+f+"` = ?")}var j=[];for(f in d.hasMany)if(d.hasMany.hasOwnProperty(f))j=j.concat(a[f].persistQueries());m(c,j,function(){if(e.length===0)b();else{a._dirtyProperties=
{};if(a._new){e.push("id");h.push(a.id);g.push("?");var l="INSERT INTO `"+a._type+"` ("+e.join(", ")+") VALUES ("+g.join(", ")+")";a._new=false}else l="UPDATE `"+a._type+"` SET "+i.join(",")+" WHERE id = '"+a.id+"'";c.executeSql(l,h,b)}})}function m(a,c,b){function d(){var g=c.pop();a.executeSql(g[0],g[1],function(){if(c.length>0)d();else b&&b.apply(this,e)})}for(var e=[],h=3;h<arguments.length;h++)e.push(arguments[h]);if(c.length>0)d();else b&&b.apply(this,e)}function H(){for(var a=[],c=0;c<32;c++)a[c]=
"0123456789ABCDEF".substr(Math.floor(Math.random()*16),1);a[12]="4";a[16]="0123456789ABCDEF".substr(a[16]&3|8,1);return a.join("")}function I(){this.sql=function(){return"1=1"};this.match=function(){return true};this.makeFit=function(){};this.makeNotFit=function(){}}function J(a,c){this.sql=function(b,d){return"("+a.sql(b,d)+" AND "+c.sql(b,d)+")"};this.match=function(b){return a.match(b)&&c.match(b)};this.makeFit=function(b){a.makeFit(b);c.makeFit(b)};this.makeNotFit=function(b){a.makeNotFit(b);
c.makeNotFit(b)}}function K(a,c,b){this.sql=function(d,e){if(c==="="&&b===null)return"`"+d+a+"` IS NULL";else if(c==="!="&&b===null)return"`"+d+a+"` IS NOT NULL";else{e.push(persistence.entityValToDbVal(b));return"`"+d+a+"` "+c+" ?"}};this.match=function(d){switch(c){case "=":return d[a]===b;case "!=":return d[a]!==b;case "<":return d[a]<b;case "<=":return d[a]<=b;case ">":return d[a]>b;case ">=":return d[a]>=b}};this.makeFit=function(d){if(c==="=")d[a]=b;else throw"Sorry, can't perform makeFit for other filters than =";
};this.makeNotFit=function(d){if(c==="=")d[a]=null;else throw"Sorry, can't perform makeNotFit for other filters than =";}}function s(){}function v(a){this.init(a,v)}function u(a){this.init(a,u);this._localAdded=[];this._localRemoved=[]}var r={},t={};persistence.trackedObjects=t;persistence.getMeta=function(a){return r[a]};persistence.connect=function(a,c,b){persistence._conn=persistence.db.connect(a,c,b)};persistence.transaction=function(a){persistence._conn.transaction(a)};persistence.define=function(a,
c){if(r[a])return k(a);r[a]={name:a,fields:c,hasMany:{},hasOne:{}};return k(a)};var x={};persistence.schemaSync=function(a){var c=[];for(var b in r)if(r.hasOwnProperty(b)){var d=r[b],e="";for(var h in d.fields)if(d.fields.hasOwnProperty(h))e+=h+" "+d.fields[h]+", ";for(var g in d.hasOne)if(d.hasOne.hasOwnProperty(g)){var i=d.hasOne[g].type.meta;e+=g+" VARCHAR(255), ";c.push(["CREATE INDEX IF NOT EXISTS `"+d.name+"_"+g+"_"+i.name+"` ON `"+d.name+"` (`"+g+"`)",null])}for(g in d.hasMany)if(d.hasMany.hasOwnProperty(g)&&
d.hasMany[g].manyToMany){var f=d.hasMany[g].tableName;if(!x[f]){i=d.hasMany[g].type.meta;c.push(["CREATE INDEX IF NOT EXISTS `"+f+"_"+d.name+"_"+g+"` ON `"+f+"` (`"+d.name+"_"+g+"`)",null]);c.push(["CREATE INDEX IF NOT EXISTS `"+f+"_"+i.name+"_"+d.hasMany[g].inverseProperty+"` ON `"+f+"` (`"+i.name+"_"+d.hasMany[g].inverseProperty+"`)",null]);c.push(["CREATE TABLE IF NOT EXISTS `"+f+"` (`"+d.name+"_"+g+"` VARCHAR(32), `"+i.name+"_"+d.hasMany[g].inverseProperty+"` VARCHAR(32))",null]);x[f]=true}}e=
e.substring(0,e.length-2);x[d.name]=true;c.push(["CREATE TABLE IF NOT EXISTS `"+d.name+"` ( id VARCHAR(32) PRIMARY KEY, "+e+")",null])}persistence.transaction(function(j){m(j,c,a,j)})};persistence.add=function(a){t[a.id]||(t[a.id]=a)};persistence.flush=function(a,c){function b(){var h=d.pop();o(h,a,function(){if(d.length>0)b();else c&&c()})}if(a){var d=[];for(var e in t)t.hasOwnProperty(e)&&d.push(t[e]);d.length>0?b():c()}else persistence.transaction(function(h){persistence.flush(h,c)})};persistence.clean=
function(){t={}};persistence.reset=function(a){function c(){var d=b.pop();a.executeSql("DROP TABLE "+d,null,function(){b.length>0&&c()})}var b=[];for(p in x)x.hasOwnProperty(p)&&b.push(p);c();persistence.clean();x={}};persistence.rowToEntity=function(a,c,b){b=b||"";if(t[c[b+"id"]])return t[c[b+"id"]];var d=r[a];a=new (k(a));a.id=c[b+"id"];a._new=false;for(var e in c)if(c.hasOwnProperty(e))if(e.substring(0,b.length)===b){var h=e.substring(b.length);if(h!="id")a[h]=persistence.dbValToEntityVal(c[e],
d.fields[h])}return a};persistence.dbValToEntityVal=function(a,c){switch(c){case "BOOL":return a===1;default:return a}};persistence.entityValToDbVal=function(a,c){return a===undefined?null:a.id?a.id:c==="BOOL"?a?1:0:a};var B={};s.prototype.persistQueries=function(){return[]};s.prototype.init=function(a,c){this._filter=new I;this._orderColumns=[];this._prefetchFields=[];this._additionalJoinSqls=[];this._additionalWhereSqls=[];this._entityName=a;this._constructor=c};s.prototype.clone=function(){var a=
new this._constructor(this._entityName);a._filter=this._filter;a._prefetchFields=this._prefetchFields.slice(0);a._orderColumns=this._orderColumns.slice(0);return a};s.prototype.filter=function(a,c,b){var d=this.clone();d._filter=new J(this._filter,new K(a,c,b));return d};s.prototype.order=function(a,c){c=c||true;var b=this.clone();b._orderColumns.push([a,c]);return b};s.prototype.prefetch=function(a){var c=this.clone();c._prefetchFields.push(a);return c};s.prototype.add=function(a){if(!a.id||!a._type)throw"Cannot add object of non-entity type onto collection.";
persistence.add(a);this._filter.makeFit(a)};s.prototype.remove=function(a){if(!a.id||!a._type)throw"Cannot remove object of non-entity type from collection.";persistence.add(a);this._filter.makeNotFit(a)};v.prototype=new s;v.prototype.list=function(a,c){function b(q,y,w){var z=["`"+y+"`.id AS "+w+"id"];for(var n in q.fields)q.fields.hasOwnProperty(n)&&z.push("`"+y+"`.`"+n+"` AS `"+w+n+"`");for(n in q.hasOne)q.hasOne.hasOwnProperty(n)&&z.push("`"+y+"`.`"+n+"` AS `"+w+n+"`");return z}for(var d=this._entityName,
e=persistence.getMeta(d),h=this,g=[],i=d+"_",f=b(e,e.name,i),j=this._additionalJoinSqls.join(" "),l=0;l<this._prefetchFields.length;l++){var A=this._prefetchFields[l],C=e.hasOne[A].type.meta,D=C.name+"_"+A+"_tbl";f=f.concat(b(C,D,A+"_"));j+="LEFT JOIN `"+C.name+"` AS `"+D+"` ON `"+D+"`.`id` = `"+i+A+"` "}l="WHERE "+[this._filter.sql(i,g)].concat(this._additionalWhereSqls).join(" AND ");var G="SELECT "+f.join(", ")+" FROM `"+d+"` "+j+" "+l;if(this._orderColumns.length>0)G+=" ORDER BY "+this._orderColumns.map(function(q){return"`"+
i+q[0]+"` "+(q[1]?"ASC":"DESC")}).join(", ");persistence.flush(a,function(){a.executeSql(G,g,function(q){for(var y=[],w=0;w<q.length;w++){for(var z=q[w],n=persistence.rowToEntity(d,z,i),E=0;E<h._prefetchFields.length;E++){var F=h._prefetchFields[E];n[F]=persistence.rowToEntity(e.hasOne[F].type.meta.name,z,F+"_")}y.push(n);persistence.add(n)}c(y)})})};u.prototype=new v;u.prototype.initManyToMany=function(a,c){this._obj=a;this._coll=c};u.prototype.add=function(a){if(!this._localAdded.contains(a)){persistence.add(a);
this._localAdded.push(a)}};u.prototype.clone=function(){var a=v.prototype.clone.call(this);a._localAdded=this._localAdded;a._localRemoved=this._localRemoved;a._obj=this._obj;a._coll=this._coll;return a};u.prototype.remove=function(a){if(this._localAdded.contains(a))this._localAdded.remove(a);else this._localRemoved.contains(a)||this._localRemoved.push(a)};u.prototype.persistQueries=function(){for(var a=[],c=persistence.getMeta(this._obj._type),b=c.hasMany[this._coll].type.meta,d=0;d<this._localAdded.length;d++)a.push(["INSERT INTO "+
c.hasMany[this._coll].tableName+" (`"+c.name+"_"+this._coll+"`, `"+b.name+"_"+c.hasMany[this._coll].inverseProperty+"`) VALUES (?, ?)",[this._obj.id,this._localAdded[d].id]]);this._localAdded=[];for(d=0;d<this._localRemoved.length;d++)a.push(["DELETE FROM  "+c.hasMany[this._coll].tableName+" WHERE `"+c.name+"_"+this._coll+"` = ? AND `"+b.name+"_"+c.hasMany[this._coll].inverseProperty+"` = ?",[this._obj.id,this._localRemoved[d].id]]);this._localRemoved=[];return a};persistence.db=persistence.db||{};
persistence.db.implementation="unsupported";persistence.db.conn=null;persistence.db.log=true;if(window.google&&google.gears)persistence.db.implementation="gears";else if(window.openDatabase)persistence.db.implementation="html5";persistence.db.html5={};persistence.db.html5.connect=function(a,c,b){var d={},e=openDatabase(a,"1.0",c,b);d.transaction=function(h){return e.transaction(function(g){return h(persistence.db.html5.transaction(g))})};return d};persistence.db.html5.transaction=function(a){var c=
{};c.executeSql=function(b,d,e,h){persistence.db.log&&console.log(b);a.executeSql(b,d,function(g,i){if(e){g=[];for(var f=0;f<i.rows.length;f++)g.push(i.rows.item(f));e(g)}},h)};return c};persistence.db.gears={};persistence.db.gears.connect=function(a){var c={},b=google.gears.factory.create("beta.database");b.open(a);c.transaction=function(d){d(persistence.db.gears.transaction(b))};return c};persistence.db.gears.transaction=function(a){var c={};c.executeSql=function(b,d,e){persistence.db.log&&console.log(b);
b=a.execute(b,d);if(e){for(d=[];b.isValidRow();){for(var h={},g=0;g<b.fieldCount();g++)h[b.fieldName(g)]=b.field(g);d.push(h);b.next()}e(d)}};return c};persistence.db.connect=function(a,c,b){if(persistence.db.implementation=="html5")return persistence.db.html5.connect(a,c,b);else if(persistence.db.implementation=="gears")return persistence.db.gears.connect(a)}})();Number.prototype.equals=function(k){return this==k};Boolean.prototype.equals=function(k){return this==k};
String.prototype.equals=function(k){return this==k};Array.prototype.equals=function(k){if(this.length!==k.length)return false;for(var o=0;o<this.length;o++)if(!this[o].equals(k[o]))return false;return true};Array.prototype.contains=function(k){for(var o=this.length,m=0;m<o;m++)if(this[m].equals(k))return true;return false};Array.prototype.remove=function(k){for(var o=this.length,m=0;m<o;m++)this[m].equals(k)&&this.splice(m,1)};
